// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int      @id @default(autoincrement())
  name      String   // Apenas no Cadastro
  phone     String   @unique // O Login é via Telefone
  password  String
  resetCode String?
  resetExpires DateTime?
  isAdmin   Boolean  @default(false)
  supervisor   Supervisor? @relation(fields: [supervisorId], references: [id])
  supervisorId Int?
  pendingSupCode String?
  balance   Decimal  @db.Decimal(18, 2) @default(0)
  bonus     Decimal  @db.Decimal(18, 2) @default(0)
  cpf       String?  @unique
  birthDate String?
  email     String?
  createdAt DateTime @default(now())
  pixCharges PixCharge[]
  transactions Transaction[]
  bets        Bet[]
  withdrawals WithdrawalRequest[]
  supervisorCommissions SupervisorCommission[]
}

model PixCharge {
  id            Int       @id @default(autoincrement())
  user          User      @relation(fields: [userId], references: [id])
  userId        Int
  amount        Decimal   @db.Decimal(18, 2)
  status        String    @default("created") // created, pending, paid, failed, expired
  txid          String    @unique
  locId         String?
  copyAndPaste  String?
  qrCodeImage   String?
  coupon        Coupon?   @relation(fields: [couponId], references: [id])
  couponId      Int?
  couponCode    String?
  bonusAmount   Decimal   @db.Decimal(18, 2) @default(0)
  expiresAt     DateTime?
  paidAt        DateTime?
  credited      Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Transaction {
  id          Int      @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id])
  userId      Int
  type        String   // deposit, debit, prize, adjustment
  amount      Decimal  @db.Decimal(18, 2) // valores positivos ou negativos
  description String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Bet {
  id          Int      @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id])
  userId      Int
  loteria     String?
  codigoHorario String?
  total       Decimal  @db.Decimal(18, 2)
  dataJogo    String?
  modalidade  String?
  colocacao   String?
  palpites    String   // JSON string de palpites/apostas
  status      String   @default("open") // open, won, lost, settled
  prize       Decimal  @db.Decimal(18, 2) @default(0)
  settledAt   DateTime?
  result      Result?  @relation(fields: [resultId], references: [id])
  resultId    Int?
  createdAt   DateTime @default(now())
  commissions SupervisorCommission[]

  @@index([loteria, dataJogo, codigoHorario])
  @@index([userId, createdAt])
  @@index([status])
  @@index([resultId])
  @@index([createdAt])
}

model Supervisor {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String?
  code      String   @unique
  createdAt DateTime @default(now())
  users     User[]
  commissions SupervisorCommission[]
}

model Result {
  id            Int      @id @default(autoincrement())
  loteria       String
  codigoHorario String?
  dataJogo      String?
  numeros       String   // JSON com resultados
  grupos        String?
  createdAt     DateTime @default(now())
  bets          Bet[]
  pules         ResultPule[]
}

model ResultPule {
  id            Int      @id @default(autoincrement())
  result        Result?  @relation(fields: [resultId], references: [id])
  resultId      Int?
  loteria       String
  codigoHorario String?
  dataJogo      String?
  numeros       String   // JSON
  grupos        String?
  createdAt     DateTime @default(now())
}

model WithdrawalRequest {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  amount    Decimal  @db.Decimal(18, 2)
  status    String   @default("pending") // pending, approved, rejected, paid
  pixKey    String?
  pixType   String?  @default("cpf")
  createdAt DateTime @default(now())

  @@index([status])
}

model Coupon {
  id         Int      @id @default(autoincrement())
  code       String   @unique
  description String?
  type       String   @default("fixed") // fixed ou percent
  amount     Decimal  @db.Decimal(18, 2)
  usageLimit Int?     // número máximo de usos
  usedCount  Int      @default(0)
  audience   String   @default("all")
  active     Boolean  @default(true)
  expiresAt  DateTime?
  createdAt  DateTime @default(now())
  pixCharges PixCharge[]
}

model SupervisorCommission {
  id           Int        @id @default(autoincrement())
  supervisor   Supervisor @relation(fields: [supervisorId], references: [id])
  supervisorId Int
  user         User       @relation(fields: [userId], references: [id])
  userId       Int
  bet          Bet?       @relation(fields: [betId], references: [id])
  betId        Int?
  amount       Decimal    @db.Decimal(18, 2)
  basis        String?    // stake, loss etc.
  status       String     @default("pending") // pending, paid, canceled
  createdAt    DateTime   @default(now())
}
