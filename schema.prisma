// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")   // pooled (-pooler)
  directUrl = env("DIRECT_URL")     // direct (sem -pooler)
}

enum CouponType {
  fixed
  percent
}

model User {
  id        Int      @id @default(autoincrement())
  name      String   // Apenas no Cadastro
  phone     String   @unique // O Login Ã© via Telefone
  password  String
  resetCode String?
  resetExpires DateTime?
  isAdmin   Boolean  @default(false)
  isBlocked Boolean  @default(false)
  supervisor   Supervisor? @relation(fields: [supervisorId], references: [id])
  supervisorId Int?
  pendingSupCode String?
  balance   Decimal  @db.Decimal(18, 2) @default(0)
  bonus     Decimal  @db.Decimal(18, 2) @default(0)
  cpf       String?  @unique
  birthDate String?
  email     String?
  createdAt DateTime @default(now())
  deletedAt DateTime?
  pixCharges PixCharge[]
  redemptions CouponRedemption[]
  transactions Transaction[]
  bets        Bet[]
  idempotencyKeys IdempotencyKey[]
  withdrawals WithdrawalRequest[]
  supervisorCommissions SupervisorCommission[]
}

model PixCharge {
  id            Int       @id @default(autoincrement())
  user          User      @relation(fields: [userId], references: [id])
  userId        Int
  amount        Decimal   @db.Decimal(18, 2)
  status        String    @default("created")
  txid          String?   @unique
  locId         String?
  copyAndPaste  String?
  qrCodeImage   String?
  expiresAt     DateTime?
  paidAt        DateTime?
  credited      Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  bonusAmount   Decimal   @default(0) @db.Decimal(18, 2)
  couponCode    String?
  couponId      Int?
  coupon        Coupon?   @relation(fields: [couponId], references: [id])

  // chave do gateway / webhook (expand step: nullable, sem unique)
  correlationId String    @unique
  webhookEvents WebhookEvent[]
}

model Transaction {
  id          Int      @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id])
  userId      Int
  type        String   // deposit, debit, prize, adjustment
  amount      Decimal  @db.Decimal(18, 2) // valores positivos ou negativos
  description String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Bet {
  id          Int      @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id])
  userId      Int
  loteria     String?
  codigoHorario String?
  total       Decimal  @db.Decimal(18, 2)
  dataJogo    String?
  modalidade  String?
  colocacao   String?
  palpites    String   // JSON string de palpites/apostas
  status      String   @default("open") // open, won, lost, settled
  prize       Decimal  @db.Decimal(18, 2) @default(0)
  prizeCreditedAt DateTime?
  settledAt   DateTime?
  recheckedAt DateTime?
  result      Result?  @relation(fields: [resultId], references: [id])
  resultId    Int?
  createdAt   DateTime @default(now())
  commissions SupervisorCommission[]
  idempotencyKeys IdempotencyKey[]

  @@index([loteria, dataJogo, codigoHorario])
  @@index([userId, createdAt])
  @@index([status])
  @@index([resultId])
  @@index([createdAt])
}

model IdempotencyKey {
  id        Int      @id @default(autoincrement())
  key       String
  route     String
  requestHash String?
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  bet       Bet?     @relation(fields: [betId], references: [id], onDelete: SetNull)
  betId     Int?
  response  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, route, key])
  @@index([userId])
  @@index([route])
  @@index([createdAt])
}

model WebhookEvent {
  id             Int      @id @default(autoincrement())
  provider       String
  eventId        String
  signatureHash  String
  correlationId  String?
  pixCharge      PixCharge? @relation(fields: [pixChargeId], references: [id], onDelete: SetNull)
  pixChargeId    Int?
  createdAt      DateTime @default(now())

  @@unique([provider, eventId])
  @@index([correlationId])
  @@index([provider])
  @@index([pixChargeId])
  @@index([createdAt])
}

model Supervisor {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String?
  code      String   @unique
  createdAt DateTime @default(now())
  users     User[]
  commissions SupervisorCommission[]
}

model Result {
  id            Int      @id @default(autoincrement())
  loteria       String
  codigoHorario String?
  dataJogo      String?
  numeros       String   // JSON com resultados
  grupos        String?
  createdAt     DateTime @default(now())
  bets          Bet[]
  pules         ResultPule[]
}

model ResultPule {
  id            Int      @id @default(autoincrement())
  result        Result?  @relation(fields: [resultId], references: [id])
  resultId      Int?
  loteria       String
  codigoHorario String?
  dataJogo      String?
  numeros       String   // JSON
  grupos        String?
  createdAt     DateTime @default(now())
}

model WithdrawalRequest {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  amount    Decimal  @db.Decimal(18, 2)
  status    String   @default("pending") // pending, approved, rejected, paid
  pixKey    String?
  pixType   String?  @default("cpf")
  createdAt DateTime @default(now())

  @@index([status])
}

model Coupon {
  id          Int        @id @default(autoincrement())
  code        String     @unique
  description String?

  type       String     @default("fixed")
  value      Decimal    @map("amount") @db.Decimal(18, 2)
  minDeposit Decimal    @db.Decimal(18, 2) @default(0)
  maxDeposit Decimal?   @db.Decimal(18, 2)

  maxUses    Int        @default(1000)
  usageLimit Int?
  usedCount  Int        @default(0)
  perUser    Int        @default(1)
  firstDepositOnly Boolean @default(false)

  audience   String     @default("all")
  active     Boolean    @default(true)
  expiresAt  DateTime?
  createdAt  DateTime   @default(now())
  pixCharges    PixCharge[]
  redemptions   CouponRedemption[]
}

model CouponRedemption {
  id            Int      @id @default(autoincrement())
  couponId      Int
  userId        Int

  depositId     String   @unique

  amountApplied Decimal  @db.Decimal(18, 2)
  createdAt     DateTime @default(now())

  coupon        Coupon   @relation(fields: [couponId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
}

model SupervisorCommission {
  id           Int        @id @default(autoincrement())
  supervisor   Supervisor @relation(fields: [supervisorId], references: [id])
  supervisorId Int
  user         User       @relation(fields: [userId], references: [id])
  userId       Int
  bet          Bet?       @relation(fields: [betId], references: [id])
  betId        Int?
  amount       Decimal    @db.Decimal(18, 2)
  basis        String?    // stake, loss etc.
  status       String     @default("pending") // pending, paid, canceled
  createdAt    DateTime   @default(now())
}

model playing_with_neon {
  id    Int    @id @default(autoincrement())
  name  String
  value Float? @db.Real
}
